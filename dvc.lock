schema: '2.0'
stages:
  createtiles@2019:
    cmd: mkdir data/processed; gdal_retile.py  -csv locations.csv  -v -ps 8192 8192
      -co "TILED=YES" -co "COMPRESS=LZW"  -targetDir data/processed.images.2019  data/raw/ortho_2019_ESPG3044.tif
    deps:
    - path: data/raw/ortho_2019_ESPG3044.tif
      md5: 746e66cb751ca75c9497920f53cdc0b8
      size: 381359748231
    params:
      params.yaml:
        source_dim: 8192
    outs:
    - path: data/processed.images.2019
      md5: a3c48148cd75adc9b069207edf27b637.dir
      size: 169321666330
      nfiles: 1925
  createmasks:
    cmd: python scripts/createmasks.py  --bbox data/raw/shapefiles/deadtrees_area/deadtrees_area.shp
      data/processed.images.2019  data/processed.masks.2019  data/raw/shapefiles/deadtrees/deadtrees.shp
    deps:
    - path: data/processed.images.2019
      md5: a3c48148cd75adc9b069207edf27b637.dir
      size: 169321666330
      nfiles: 1925
    - path: data/raw/shapefiles/deadtrees
      md5: fdc094c879c6588fe71d19a7177eda48.dir
      size: 1665350
      nfiles: 5
    - path: data/raw/shapefiles/deadtrees_area
      md5: f098a36246abde3d3e0c0efa6183093a.dir
      size: 1756
      nfiles: 5
    outs:
    - path: data/processed.masks.2019
      md5: bcdadbbf7cb31f3a2a4f437290dcbd28.dir
      size: 3288758774
      nfiles: 49
  createdataset:
    cmd: python scripts/createdataset.py data/processed.images.2019 data/processed.masks.2019
      data/dataset  --source_dim 8192 --tile_size 512 --format PNG
    deps:
    - path: data/processed.images.2019
      md5: a3c48148cd75adc9b069207edf27b637.dir
      size: 169321666330
      nfiles: 1925
    - path: data/processed.masks.2019
      md5: bcdadbbf7cb31f3a2a4f437290dcbd28.dir
      size: 3288758774
      nfiles: 49
    params:
      params.yaml:
        createdataset.tile_size: 512
        file_type: PNG
        source_dim: 8192
    outs:
    - path: data/dataset/stats.csv
      md5: 06da46443d403f1fd39a2c75131ec3b4
      size: 387162
    - path: data/dataset/train
      md5: ea28c53f1d87e38f519f9674e7728dc7.dir
      size: 4677847040
      nfiles: 23
  createbalanced:
    cmd: python scripts/createbalanced.py  data/dataset/stats.csv data/dataset/train  data/dataset/train_balanced  data/dataset/train_balanced_short
      --format PNG --tmp-dir ./tmp
    deps:
    - path: data/dataset/stats.csv
      md5: 06da46443d403f1fd39a2c75131ec3b4
      size: 387162
    - path: data/dataset/train
      md5: ea28c53f1d87e38f519f9674e7728dc7.dir
      size: 4677847040
      nfiles: 23
    params:
      params.yaml:
        file_type: PNG
    outs:
    - path: data/dataset/train_balanced
      md5: 7df9d2814d314cca795889d257d9d281.dir
      size: 4644628480
      nfiles: 44
    - path: data/dataset/train_balanced_short
      md5: f0bb5fb08c815bf826684b7d542f355d.dir
      size: 308807680
      nfiles: 11
  createtiles@2017:
    cmd: mkdir -p data/processed.images.2017; gdal_retile.py  -csv locations.csv  -v
      -ps 8192 8192 -co "TILED=YES" -co "COMPRESS=LZW"  -targetDir data/processed.images.2017  data/raw/ortho_2017_ESPG3044.tif
    deps:
    - path: data/raw/ortho_2017_ESPG3044.tif
      md5: a3dbc3a39bd6bb1c932ee887af198901
      size: 381359748231
    params:
      params.yaml:
        source_dim: 8192
    outs:
    - path: data/processed.images.2017
      md5: 78c52e327b8dcd7dfbb5d43790326eb3.dir
      size: 143381387397
      nfiles: 1925
  inference@2017:
    cmd: mkdir -p data/predicted.2017; mkdir -p data/predicted.2017_preview; stdbuf
      -i0 -o0 -e0 python deadtrees/deployment/tiler.py --all -o data/predicted.2017
      data/processed.images.2017; gdal_merge.py  -co 'COMPRESS=LZW'  -co 'TILED=YES'  -o
      data/predicted_mosaic_2017.tif  data/predicted.2017/ortho_2017_ESPG3044_*
    deps:
    - path: data/processed.images.2017
      md5: 78c52e327b8dcd7dfbb5d43790326eb3.dir
      size: 143381387397
      nfiles: 1925
    outs:
    - path: data/predicted.2017
      md5: 0fa9ac1bea4ac07d7a7c0835d9970ccf.dir
      size: 622677074
      nfiles: 1395
    - path: data/predicted.2017_preview
      md5: ff79762b14ac023237333d61d4d26df3.dir
      size: 92731291854
      nfiles: 1395
    - path: data/predicted_mosaic_2017.tif
      md5: 8dcc91d8bfe3ae428c26938887ddc18d
      size: 849386546
  inference@2019:
    cmd: mkdir -p data/predicted.2019; mkdir -p data/predicted.2019_preview; stdbuf
      -i0 -o0 -e0 python deadtrees/deployment/tiler.py --all -o data/predicted.2019
      data/processed.images.2019; gdal_merge.py  -co 'COMPRESS=LZW'  -co 'TILED=YES'  -o
      data/predicted_mosaic_2019.tif  data/predicted.2019/ortho_2019_ESPG3044_*
    deps:
    - path: data/processed.images.2019
      md5: a3c48148cd75adc9b069207edf27b637.dir
      size: 169321666330
      nfiles: 1925
    outs:
    - path: data/predicted.2019
      md5: 2de1815d33b469bbd5465ce121ed4b6c.dir
      size: 499453393
      nfiles: 1089
    - path: data/predicted.2019_preview
      md5: e4fecc7999cc0745e25d47f648d2f7e0.dir
      size: 73081685754
      nfiles: 1089
    - path: data/predicted_mosaic_2019.tif
      md5: 447a0b1b83b01986b52b360e5fbacc54
      size: 806817013
